{
  "version": 3,
  "sources": ["../../../js/tetra.core.js", "../../../js/tetra.js"],
  "sourcesContent": ["const Tetra = {\n  init() {\n    Alpine.magic('static', () => Tetra.$static);\n  },\n\n  $static() {\n    return (path) => {\n      return window.__tetra_staticRoot+path;\n    }\n  },\n\n  alpineComponentMixins() {\n    return {\n      // Alpine.js lifecycle:\n      init() {\n        this.$dispatch('tetra:child-component-init', {component:  this});\n        this.__initServerWatchers();\n        if (this.__initInner) {\n          this.__initInner();\n        }\n      },\n      destroy() {\n        this.$dispatch('tetra:child-component-destroy', {component:  this});\n        if (this.__destroyInner) {\n          this.__destroyInner();\n        }\n      },\n\n      // Tetra Builtins:\n      _updateHtml(html) {\n        Alpine.morph(this.$root, html, {\n          updating(el, toEl, childrenOnly, skip) {\n            if (toEl.hasAttribute && toEl.hasAttribute('x-data-maintain') && el.hasAttribute && el.hasAttribute('x-data')) {\n              toEl.setAttribute('x-data', el.getAttribute('x-data'));\n              toEl.removeAttribute('x-data-maintain');\n            } else if (toEl.hasAttribute && toEl.hasAttribute('x-data-update') && el.hasAttribute && el.hasAttribute('x-data')) {\n              let data = Tetra.jsonDecode(toEl.getAttribute('x-data-update'));\n              let old_data = Tetra.jsonDecode(toEl.getAttribute('x-data-update-old'));\n              let comp = window.Alpine.$data(el);\n              for (const key in data) {\n                if (old_data.hasOwnProperty(key) && (old_data[key] !== comp[key])) {\n                  // If the data that was submitted to the server has since changed we don't overwrite it\n                  continue\n                }\n                comp[key] = data[key];\n              }\n              toEl.setAttribute('x-data', el.getAttribute('x-data'));\n              toEl.removeAttribute('x-data-update');\n            }\n          },\n          lookahead: true\n        });\n      },\n      _updateData(data) {\n        for (const key in data) {\n          this[key] = data[key];\n        }\n      },\n      _removeComponent() {\n        this.$root.remove();\n      },\n      _replaceComponentAndState(html) {\n        this.$root.insertAdjacentHTML('afterend', html);\n        this.$root.remove();\n      },\n      _redirect(url) {\n        document.location = url;\n      },\n      _dispatch(name, data) {\n        this.$dispatch(name, {\n          _component: this,\n          ...data\n        });\n      },\n\n      // Tetra private:\n      __initServerWatchers() {\n        this.__serverMethods.forEach(item => {\n          if (item.watch) {\n            item.watch.forEach(propName => {\n              this.$watch(propName, async (value, oldValue) => {\n                await this[item.name](value, oldValue, propName);\n              })\n            })\n          }\n        })\n      },\n      __childComponents: {},\n      __rootBind: {\n        ['@tetra:child-component-init'](event) {\n          event.stopPropagation();\n          const comp = event.detail.component;\n          if (comp.key === this.key) {\n            return\n          }\n          if (comp.key) {\n            this.__childComponents[comp.key] = comp;\n          }\n          comp._parent = this;\n        },\n        ['@tetra:child-component-destroy'](event) {\n          event.stopPropagation();\n          const comp = event.detail.component;\n          if (comp.key === this.key) {\n            return\n          }\n          delete this.__childComponents[comp.key];\n          event.detail.component._parent = null;\n        }\n      }\n    }\n  },\n\n  makeServerMethods(serverMethods) {\n    const methods = {};\n    serverMethods.forEach((serverMethod) => {\n      var func = async function(...args) {\n        // TODO: ensure only one concurrent?\n        return await Tetra.callServerMethod(this, serverMethod.name, serverMethod.endpoint, args)\n      }\n      if (serverMethod.debounce) {\n        func = Tetra.debounce(func, serverMethod.debounce, serverMethod.debounce_immediate)\n      } else if (serverMethod.throttle) {\n        func = Tetra.throttle(func, serverMethod.throttle, {\n          leading: serverMethod.throttle_leading,\n          trailing: serverMethod.throttle_trailing\n        })\n      }\n      methods[serverMethod.name] = func;\n    })\n    return methods\n  },\n\n  makeAlpineComponent(componentName, script, serverMethods, serverProperties) {\n    Alpine.data(\n      componentName, \n      (initialDataJson) => {\n        const {init, destroy, ...script_rest} = script;\n        const initialData = Tetra.jsonDecode(initialDataJson);\n        const data = {\n          componentName,\n          __initInner: init,\n          __destroyInner: destroy,\n          __serverMethods: serverMethods,\n          __serverProperties: serverProperties,\n          ...(initialData || {}),\n          ...script_rest,\n          ...Tetra.makeServerMethods(serverMethods),\n          ...Tetra.alpineComponentMixins(),\n        }\n        return data\n      }\n    )\n  },\n\n  getStateWithChildren(component) {\n    const data = {}\n    component.__serverProperties.forEach((key) => {\n      data[key] = component[key]\n    })\n    const r = {\n      state: component.__state,\n      data: data,\n      children: []\n    }\n    for (const key in component.__childComponents) {\n      const comp = component.__childComponents[key];\n      r.children.push(Tetra.getStateWithChildren(comp));\n    }\n    return r;\n  },\n\n  loadScript(src) {\n    return new Promise((resolve, reject) => {\n      const script = document.createElement('script');\n      script.src = src;\n      script.onload = resolve;\n      script.onerror = reject;\n      document.head.appendChild(script);\n    });\n  },\n\n  loadStyles(href) {\n    return new Promise((resolve, reject) => {\n      const link = document.createElement('link');\n      link.href = href;\n      link.rel  = 'stylesheet';\n      link.type = 'text/css';\n      link.onload = resolve;\n      link.onerror = reject;\n      document.head.appendChild(link);\n    });\n  },\n\n  async callServerMethod(component, methodName, methodEndpoint, args) {\n    // TODO: error handling\n    body = Tetra.getStateWithChildren(component);\n    body.args = args;\n    const response = await fetch(methodEndpoint, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'X-CSRFToken': window.__tetra_csrfToken,\n      },\n      mode: 'same-origin',\n      body: Tetra.jsonEncode(body),\n    });\n    if (response.status === 200) {\n      const respData = Tetra.jsonDecode(await response.text()); \n      if (respData.success) {\n        let loadingResources = [];\n        respData.js.forEach(src => {\n          if (!document.querySelector(`script[src=\"${CSS.escape(src)}\"]`)) {\n            loadingResources.push(Tetra.loadScript(src));\n          }\n        })\n        respData.styles.forEach(src => {\n          if (!document.querySelector(`link[href=\"${CSS.escape(src)}\"]`)) {\n            loadingResources.push(Tetra.loadStyles(src));\n          }\n        })\n        await Promise.all(loadingResources);\n        if (respData.callbacks) {\n          respData.callbacks.forEach((item) => {\n            // iterate down path to callback\n            let obj = component;\n            item.callback.forEach((name, i) => {\n              if (i === item.callback.length-1) {\n                obj[name](...item.args);\n              } else {\n                obj = obj[name];\n                console.log(name, obj)\n              }\n            })\n          })\n        }\n        return respData.result;\n      } else {\n        // TODO: better errors\n        throw new Error('Error processing public method');\n      }\n    } else {\n      throw new Error(`Server responded with an error ${response.status} (${response.statusText})`);\n    }\n  },\n\n  jsonReplacer(key, value) {\n    if (value instanceof Date) {\n      return {\n        __type: 'datetime',\n        value: value.toISOString(),\n      };\n    } else if (value instanceof Set) {\n      return {\n        __type: 'set',\n        value: Array.from(value)\n      };\n    } \n    return value;\n  },\n\n  jsonReviver(key, value) {\n    if (value && typeof value === 'object' && value.__type) {\n      if (value.__type === 'datetime') {\n        return new Date(value);\n      } else if (value.__type === 'set') {\n        return new Set(value);\n      }\n    }\n    return value\n  },\n\n  jsonEncode(obj) {\n    return JSON.stringify(obj, Tetra.jsonReplacer);\n  },\n\n  jsonDecode(s) {\n    var obj= JSON.parse(s, Tetra.jsonReviver);\n    return obj\n  },\n\n  debounce(func, wait, immediate) {\n    var timeout\n    return function() {\n      var context = this, args = arguments\n      var later = function () {\n        timeout = null\n        if (!immediate) func.apply(context, args);\n      }\n      var callNow = immediate && !timeout;\n      clearTimeout(timeout);\n      timeout = setTimeout(later, wait);\n      if (callNow) func.apply(context, args);\n    }\n  },\n\n  throttle(func, wait, options) {\n    // From Underscore.js\n    // https://underscorejs.org\n    // (c) 2009-2022 Jeremy Ashkenas, Julian Gonggrijp, and DocumentCloud and\n    // Investigative Reporters & Editors\n    // Underscore may be freely distributed under the MIT license.\n    // --\n    // Returns a function, that, when invoked, will only be triggered at most once\n    // during a given window of time. Normally, the throttled function will run\n    // as much as it can, without ever going more than once per `wait` duration;\n    // but if you'd like to disable the execution on the leading edge, pass\n    // `{leading: false}`. To disable execution on the trailing edge, ditto.\n    var timeout, context, args, result;\n    var previous = 0;\n    if (!options) options = {};\n\n    var later = function() {\n      previous = options.leading === false ? 0 : now();\n      timeout = null;\n      result = func.apply(context, args);\n      if (!timeout) context = args = null;\n    };\n\n    var throttled = function() {\n      var _now = new Date().getTime();\n      if (!previous && options.leading === false) previous = _now;\n      var remaining = wait - (_now - previous);\n      context = this;\n      args = arguments;\n      if (remaining <= 0 || remaining > wait) {\n        if (timeout) {\n          clearTimeout(timeout);\n          timeout = null;\n        }\n        previous = _now;\n        result = func.apply(context, args);\n        if (!timeout) context = args = null;\n      } else if (!timeout && options.trailing !== false) {\n        timeout = setTimeout(later, remaining);\n      }\n      return result;\n    };\n\n    throttled.cancel = function() {\n      clearTimeout(timeout);\n      previous = 0;\n      timeout = context = args = null;\n    };\n\n    return throttled;\n  }\n\n}\n\nexport default Tetra;\n", "import Tetra from './tetra.core'\n\nwindow.Tetra = Tetra;\nwindow.document.addEventListener('alpine:init', () => {\n  Tetra.init();\n})\n"],
  "mappings": "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",
  "names": []
}
